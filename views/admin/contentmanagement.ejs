    <!DOCTYPE html>
    <html lang="en">
    <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Content Management | Traveezy</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        a { text-decoration: none; color: inherit; }

        /* .logo { margin: auto; }
        .logo img { height: auto; width: 130px; } */

        .sidebar-item.active {
        background-color: #f3f4f6;
        border-left: 3px solid #14b8a6;
        }
        .star-rating { color: #fbbf24; }
        .status-badge { display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; }
        .status-published { background-color: #10b981; color: white; }
        .status-draft { background-color: #3b82f6; color: white; }
        .status-archived { background-color: #ef4444; color: white; }
        .action-btn { padding: 6px 12px; border: 1px solid #e5e7eb; border-radius: 6px; cursor: pointer; font-size: 14px; transition: all 0.2s; }
        .action-btn:hover { background-color: #f9fafb; }
        .btn-teal { background-color: #14b8a6; color: white; padding: 8px 16px; border-radius: 6px; border: none; cursor: pointer; font-weight: 500; }
        .btn-teal:hover { background-color: #0d9488; }
        .dropdown { padding: 8px 12px; border: 1px solid #e5e7eb; border-radius: 6px; background-color: white; cursor: pointer; font-size: 14px; }
        .place-image { width: 48px; height: 48px; border-radius: 6px; object-fit: cover; }
        .pagination-btn { width: 36px; height: 36px; border: 1px solid #e5e7eb; border-radius: 6px; cursor: pointer; background-color: white; font-size: 14px; }
        .pagination-btn.active { background-color: #14b8a6; color: white; border-color: #14b8a6; }
    </style>
    <style>
        .calendar-day { transition: background-color 0.2s; }
        .calendar-day.blocked { background-color: #fecaca; color: #dc2626; font-weight: bold; }
        .calendar-day.blocked:hover { background-color: #fca5a5; }
        .calendar-day:not(.disabled):not(.blocked):hover { background-color: #d1fae5; cursor: pointer; }
        .calendar-day.today { border: 2px solid #14b8a6; }
        .calendar-day.disabled { color: #d1d5db; }
    </style>
    </head>
    <body class="bg-gray-50">
    <div class="flex h-screen">
        <!-- Sidebar partial -->
        <%- include('../partials/sidebar') %>

        <div class="flex-1 flex flex-col">
        <!-- Header partial -->
        <%- include('../partials/header') %>

        <main class="flex-1 overflow-auto p-8">
            <!-- Page-specific content -->
            <div class="mb-8">
            <h1 class="text-3xl font-bold text-gray-900 mb-2">Places Management</h1>
            <p class="text-gray-600">Manage all discoverable places on Traveezy. Edit, delete, and add new locations.</p>
            </div>

            <!-- Filters -->
            <div class="bg-white rounded-lg p-6 mb-6 flex gap-4 items-center">
            <div class="flex-1 relative">
                <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                <input type="text" placeholder="Search places by name..." class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500">
            </div>
            <select class="dropdown"><option>All</option></select>
            <select class="dropdown"><option>All</option></select>
            <select class="dropdown"><option>All</option></select>
           <button id="openAddModal" class="btn-teal flex items-center gap-2">
    <i class="fas fa-plus"></i> Add New Place
</button>

            </div>

            <!-- Table -->
            <div class="bg-white rounded-lg overflow-hidden">
            <table class="w-full">
                <thead class="bg-gray-50 border-b border-gray-200">
                <tr>
                    <th class="px-6 py-4 text-left text-sm font-semibold text-gray-700">Place Name</th>
                    <th class="px-6 py-4 text-left text-sm font-semibold text-gray-700">Category</th>
                    <th class="px-6 py-4 text-left text-sm font-semibold text-gray-700">Status</th>
                    <th class="px-6 py-4 text-left text-sm font-semibold text-gray-700">Rating</th>
                    <th class="px-6 py-4 text-left text-sm font-semibold text-gray-700">Actions</th>
                </tr>
                </thead>
                <tbody>
                <% if (places && places.length > 0) { %>
                    <% places.forEach(place => { %>
                    <tr class="border-b border-gray-200 hover:bg-gray-50">
                        <td class="px-6 py-4">
                        <div class="flex items-center gap-3">
                            <img src="<%= place.image || 'https://via.placeholder.com/48' %>" alt="<%= place.name %>" class="place-image">
                            <span class="font-medium text-gray-900"><%= place.name %></span>
                        </div>
                        </td>
                        <td class="px-6 py-4 text-gray-600"><%= place.category %></td>
                        <td class="px-6 py-4">
                        <% if (place.status === 'Published') { %>
                            <span class="status-badge status-published">Published</span>
                        <% } else if (place.status === 'Draft') { %>
                            <span class="status-badge status-draft">Draft</span>
                        <% } else { %>
                            <span class="status-badge status-archived">Archived</span>
                        <% } %>
                        </td>
                        <td class="px-6 py-4">
                        <div class="star-rating">
                            <% for (let i = 1; i <= 5; i++) { %>
                            <% if (i <= Math.floor(place.rating)) { %>
                                <i class="fas fa-star"></i>
                            <% } else if (i - place.rating < 1 && place.rating % 1 !== 0) { %>
                                <i class="fas fa-star-half-alt"></i>
                            <% } else { %>
                                <i class="far fa-star"></i>
                            <% } %>
                            <% } %>
                        </div>
                        </td>

                        <td class="px-6 py-4">
  <div class="flex items-center gap-2">
      <button class="action-btn flex items-center gap-2" onclick='openEditModal(<%- JSON.stringify(place) %>)'>
          <i class="fas fa-edit"></i> Edit
      </button>
      <a href="/admin/deleteplace/<%= place._id %>" class="action-btn flex items-center gap-2" onclick="return confirm('Delete this place?');">
          <i class="fas fa-trash"></i> Delete
      </a>
      <button class="btn-teal text-sm" onclick='openAvailabilityModal(<%- JSON.stringify(place) %>)'>Availability</button>
      <button class="action-btn flex items-center gap-2" onclick='openViewModal(<%- JSON.stringify(place) %>)'>
          <i class="fas fa-eye"></i> View
      </button>
  </div>
</td>

                    </tr>
                    <% }) %>
                <% } else { %>
                    <tr>
                    <td colspan="5" class="text-center py-6 text-gray-500">No places found</td>
                    </tr>
                <% } %>
                </tbody>
            </table>
            </div>

            <!-- Pagination -->
            <div class="flex justify-between items-center mt-6">
            <div></div>
            <div class="flex items-center gap-2">
                <button class="pagination-btn" <%= currentPage > 1 ? '' : 'disabled' %> onclick="window.location.href='?page=<%= currentPage - 1 %>'">
                <i class="fas fa-chevron-left"></i>
                </button>
                <% for (let i = 1; i <= totalPages; i++) { %>
                <button class="pagination-btn <%= currentPage === i ? 'active' : '' %>" onclick="window.location.href='?page=<%= i %>'"><%= i %></button>
                <% } %>
                <button class="pagination-btn" <%= currentPage < totalPages ? '' : 'disabled' %> onclick="window.location.href='?page=<%= currentPage + 1 %>'">
                <i class="fas fa-chevron-right"></i>
                </button>
            </div>
            </div>
        </main>
        </div>
    </div>


  <!-- Add Place Modal -->
<div id="addPlaceModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-2xl w-full max-w-lg shadow-lg p-6 relative">
        <h2 class="text-2xl font-semibold text-gray-800 mb-4">Add New Place</h2>
        <form action="/admin/addplace" method="POST" enctype="multipart/form-data" class="space-y-4">
            <div>
                <label class="block text-gray-700 mb-1 font-medium">Place Name</label>
                <input type="text" name="name" required class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-teal-500 focus:outline-none">
            </div>
            <div>
              <label class="block text-gray-700 mb-1 font-medium">Category</label>
              <select name="category" required class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-teal-500 focus:outline-none">
                <option value="">Select Category</option>
                <option value="Resort">Resort</option>
                <option value="Food Spot">Food Spot</option>
                <option value="Adventure Park">Adventure Park</option>
                <option value="View Point">View Point</option>
                <option value="Temple">Temple</option>
                <option value="Museum">Museum</option>
                <option value="Beach">Beach</option>
                <option value="Waterfall">Waterfall</option>
                <option value="Shopping">Shopping</option>
              </select>
            </div>

            <div>
                <label class="block text-gray-700 mb-1 font-medium">Status</label>
                <select name="status" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-teal-500 focus:outline-none">
                    <option value="Published">Published</option>
                    <option value="Draft">Draft</option>
                    <option value="Archived">Archived</option>
                </select>
            </div>
            <div>
                <label class="block text-gray-700 mb-1 font-medium">Rating</label>
                <input type="number" name="rating" step="0.1" min="0" max="5" value="4.5" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-teal-500 focus:outline-none">
            </div>
            <div>
                <label class="block text-gray-700 mb-1 font-medium">Upload Image</label>
                <div class="flex items-center gap-4">
                    <img id="imagePreview" src="https://via.placeholder.com/120?text=Preview" class="w-24 h-24 object-cover rounded-full border border-gray-300" alt="Preview">
                    <input type="file" name="image" accept="image/*" onchange="previewImage(event)" class="border border-gray-300 rounded-lg px-3 py-2 w-full focus:ring-2 focus:ring-teal-500 focus:outline-none">
                </div>
            </div>
            <div class="flex justify-end gap-3 pt-4 border-t border-gray-200">
                <button type="button" onclick="closeModal()" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-600 hover:bg-gray-100">Cancel</button>
                <button type="submit" class="btn-teal">Save Place</button>
            </div>
        </form>
        <button onclick="closeModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
            <i class="fas fa-times text-xl"></i>
        </button>
    </div>
</div>

<!-- Edit Place Modal -->
<div id="editPlaceModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
  <div class="bg-white rounded-2xl w-full max-w-lg shadow-lg p-6 relative">
    <h2 class="text-2xl font-semibold text-gray-800 mb-4">Edit Place</h2>
    <form id="editPlaceForm" action="/admin/updateplace" method="POST" enctype="multipart/form-data" class="space-y-4">
      <input type="hidden" name="id" id="editPlaceId">

      <div>
        <label class="block text-gray-700 mb-1 font-medium">Place Name</label>
        <input type="text" name="name" id="editPlaceName" required
          class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-teal-500 focus:outline-none">
      </div>

      <div>
        <label class="block text-gray-700 mb-1 font-medium">Category</label>
        <select name="category" id="editPlaceCategory" required
          class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-teal-500 focus:outline-none">
          <option value="">Select Category</option>
          <option value="Resort">Resort</option>
          <option value="Food Spot">Food Spot</option>
          <option value="Adventure Park">Adventure Park</option>
          <option value="View Point">View Point</option>
          <option value="Temple">Temple</option>
          <option value="Museum">Museum</option>
          <option value="Beach">Beach</option>
          <option value="Waterfall">Waterfall</option>
          <option value="Shopping">Shopping</option>
        </select>
      </div>

      <div>
        <label class="block text-gray-700 mb-1 font-medium">Status</label>
        <select name="status" id="editPlaceStatus"
          class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-teal-500 focus:outline-none">
          <option value="Published">Published</option>
          <option value="Draft">Draft</option>
          <option value="Archived">Archived</option>
        </select>
      </div>

      <div>
        <label class="block text-gray-700 mb-1 font-medium">Rating</label>
        <input type="number" name="rating" step="0.1" min="0" max="5" id="editPlaceRating"
          class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-teal-500 focus:outline-none">
      </div>

      <div>
        <label class="block text-gray-700 mb-1 font-medium">Upload Image</label>
        <div class="flex items-center gap-4">
          <img id="editImagePreview" src="https://via.placeholder.com/120?text=Preview"
            class="w-24 h-24 object-cover rounded-full border border-gray-300" alt="Preview">
          <input type="file" name="image" accept="image/*" onchange="previewEditImage(event)"
            class="border border-gray-300 rounded-lg px-3 py-2 w-full focus:ring-2 focus:ring-teal-500 focus:outline-none">
        </div>
      </div>

      <div class="flex justify-end gap-3 pt-4 border-t border-gray-200">
        <button type="button" onclick="closeEditModal()"
          class="px-4 py-2 border border-gray-300 rounded-lg text-gray-600 hover:bg-gray-100">Cancel</button>
        <button type="submit" class="btn-teal">Save Changes</button>
      </div>
    </form>

    <button onclick="closeEditModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
      <i class="fas fa-times text-xl"></i>
    </button>
  </div>
</div>

<!-- View Place Modal -->
<div id="viewPlaceModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
  <div class="bg-white rounded-2xl w-full max-w-md shadow-lg p-6 relative">
    <h2 class="text-2xl font-semibold text-gray-800 mb-4">View Place</h2>
    <div class="space-y-3">
      <div class="flex items-center gap-3">
        <img id="viewPlaceImage" src="https://via.placeholder.com/120?text=Preview" class="w-24 h-24 object-cover rounded-full border border-gray-300">
        <div>
          <h3 id="viewPlaceName" class="text-lg font-bold"></h3>
          <p id="viewPlaceCategory" class="text-gray-600"></p>
        </div>
      </div>
      <p>Status: <span id="viewPlaceStatus" class="font-medium"></span></p>
      <p>Rating: <span id="viewPlaceRating" class="font-medium"></span></p>
      <div class="pt-2">
        <p class="text-gray-800">Today's Status: 
          <span id="viewPlaceAvailability" class="font-bold"></span></p>
      </div>
    </div>
    <div class="flex justify-end pt-4 border-t border-gray-200">
      <button onclick="closeViewModal()" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-600 hover:bg-gray-100">Close</button>
    </div>
    <button onclick="closeViewModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
      <i class="fas fa-times text-xl"></i>
    </button>
  </div>
</div>

<!-- Availability Calendar Modal -->
<div id="availabilityModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
  <div class="bg-white rounded-2xl w-full max-w-lg shadow-lg p-6 relative">
    <h2 class="text-2xl font-semibold text-gray-800 mb-1">Manage Availability</h2>
    <p class="text-gray-600 mb-4" id="availabilityPlaceName"></p>
    
    <div class="flex items-center justify-between mb-4">
      <button id="prevMonthBtn" class="pagination-btn"><i class="fas fa-chevron-left"></i></button>
      <h3 id="monthYear" class="text-lg font-semibold"></h3>
      <button id="nextMonthBtn" class="pagination-btn"><i class="fas fa-chevron-right"></i></button>
    </div>

    <div id="calendar" class="grid grid-cols-7 gap-1 text-center"></div>

    <div class="flex justify-end gap-3 pt-4 mt-4 border-t border-gray-200">
      <button type="button" onclick="closeAvailabilityModal()" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-600 hover:bg-gray-100">Done</button>
    </div>

    <button onclick="closeAvailabilityModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
      <i class="fas fa-times text-xl"></i>
    </button>
  </div>
</div>

<script>
const modal = document.getElementById('addPlaceModal');
const addBtn = document.getElementById('openAddModal');

addBtn.addEventListener('click', (e) => {
  e.preventDefault();
  modal.classList.remove('hidden');
  modal.classList.add('flex');
});
function closeModal() { modal.classList.add('hidden'); modal.classList.remove('flex'); }
function previewImage(event) {
  const file = event.target.files[0];
  const preview = document.getElementById('imagePreview');
  if (file) {
    const reader = new FileReader();
    reader.onload = e => { preview.src = e.target.result; };
    reader.readAsDataURL(file);
  } else { preview.src = "https://via.placeholder.com/120?text=Preview"; }
}

// Edit Modal
const editModal = document.getElementById('editPlaceModal');
function openEditModal(place) {
  document.getElementById('editPlaceId').value = place._id;
  document.getElementById('editPlaceName').value = place.name;
  document.getElementById('editPlaceCategory').value = place.category;
  document.getElementById('editPlaceStatus').value = place.status;
  document.getElementById('editPlaceRating').value = place.rating;
  document.getElementById('editImagePreview').src = place.image || "https://via.placeholder.com/120?text=Preview";
  editModal.classList.remove('hidden'); editModal.classList.add('flex');
}
function closeEditModal() { editModal.classList.add('hidden'); editModal.classList.remove('flex'); }
function previewEditImage(event) {
  const file = event.target.files[0];
  const preview = document.getElementById('editImagePreview');
  if (file) {
    const reader = new FileReader();
    reader.onload = e => { preview.src = e.target.result; };
    reader.readAsDataURL(file);
  } else { preview.src = "https://via.placeholder.com/120?text=Preview"; }
}

// View Modal
const viewModal = document.getElementById('viewPlaceModal');
function openViewModal(place) {
  document.getElementById('viewPlaceName').innerText = place.name;
  document.getElementById('viewPlaceCategory').innerText = place.category;
  document.getElementById('viewPlaceStatus').innerText = place.status;
  document.getElementById('viewPlaceRating').innerText = place.rating;
  document.getElementById('viewPlaceImage').src = place.image || "https://via.placeholder.com/120?text=Preview";

  // --- Check Today's Availability ---
  // Use UTC date to avoid timezone mismatches with stored dates
  const todayString = new Date().toISOString().split('T')[0];

  // The dates from JSON.stringify are full ISO strings. We just need the date part.
  const blockedDateStrings = (place.blockedDates || []).map(d => d.substring(0, 10));
  const isBlockedToday = blockedDateStrings.includes(todayString);
  const availabilityEl = document.getElementById('viewPlaceAvailability');
  availabilityEl.innerText = isBlockedToday ? 'Blocked' : 'Available';
  availabilityEl.className = isBlockedToday ? 'font-bold text-red-600' : 'font-bold text-green-600';

  viewModal.classList.remove('hidden'); viewModal.classList.add('flex');
}
function closeViewModal() { 
    viewModal.classList.add('hidden'); 
    viewModal.classList.remove('flex'); 
}

// --- Availability Calendar ---
const availabilityModal = document.getElementById('availabilityModal');
const calendarEl = document.getElementById('calendar');
const monthYearEl = document.getElementById('monthYear');
const prevMonthBtn = document.getElementById('prevMonthBtn');
const nextMonthBtn = document.getElementById('nextMonthBtn');

let currentPlaceId = null;
let currentDate = new Date();
let blockedDates = [];

function openAvailabilityModal(place) {
  currentPlaceId = place._id;
  document.getElementById('availabilityPlaceName').innerText = `For: ${place.name}`;
  
  fetch(`/admin/places/${currentPlaceId}/blocked-dates`)
    .then(res => res.json())
    .then(dates => {
      blockedDates = Array.isArray(dates) ? dates : [];
      renderCalendar(currentDate.getFullYear(), currentDate.getMonth());
      availabilityModal.classList.remove('hidden');
      availabilityModal.classList.add('flex');
    })
    .catch(err => console.error('Failed to fetch blocked dates', err));
}

function closeAvailabilityModal() {
  availabilityModal.classList.add('hidden');
  availabilityModal.classList.remove('flex');
  currentPlaceId = null;
  blockedDates = [];
}

function renderCalendar(year, month) {
  calendarEl.innerHTML = '';
  const firstDay = new Date(year, month, 1);
  const lastDay = new Date(year, month + 1, 0);
  
  monthYearEl.innerText = firstDay.toLocaleString('default', { month: 'long', year: 'numeric' });

  const daysOfWeek = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
  daysOfWeek.forEach(day => {
    const dayEl = document.createElement('div');
    dayEl.className = 'font-semibold text-sm text-gray-600';
    dayEl.innerText = day;
    calendarEl.appendChild(dayEl);
  });

  for (let i = 0; i < firstDay.getDay(); i++) {
    const emptyEl = document.createElement('div');
    calendarEl.appendChild(emptyEl);
  }

  for (let i = 1; i <= lastDay.getDate(); i++) {
    const dayEl = document.createElement('div');
    const date = new Date(year, month, i);
    const dateString = date.toISOString().split('T')[0];
    
    dayEl.innerText = i;
    dayEl.className = 'p-2 rounded-full calendar-day';
    dayEl.dataset.date = dateString;

    if (blockedDates.includes(dateString)) {
      dayEl.classList.add('blocked');
    }

    dayEl.addEventListener('click', () => toggleDateBlock(dateString));
    calendarEl.appendChild(dayEl);
  }
}

async function toggleDateBlock(dateString) {
  try {
    const res = await fetch(`/admin/places/${currentPlaceId}/toggle-blocked-date`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ date: dateString })
    });
    const data = await res.json();
    if (data.success) {
      blockedDates = data.blockedDates;
      renderCalendar(currentDate.getFullYear(), currentDate.getMonth());

      // --- FIX: Update the main 'places' array so the View modal is correct ---
      const placeIndex = places.findIndex(p => p._id === currentPlaceId);
      if (placeIndex > -1) {
        // Convert date strings back to Date objects for consistency with original data structure
        // The backend sends 'YYYY-MM-DD', we need to convert them to full ISO strings
        places[placeIndex].blockedDates = data.blockedDates.map(d => new Date(d).toISOString());
      }
    }
  } catch (err) {
    console.error('Failed to toggle date block', err);
  }
}

prevMonthBtn.addEventListener('click', () => {
  currentDate.setMonth(currentDate.getMonth() - 1);
  renderCalendar(currentDate.getFullYear(), currentDate.getMonth());
});

nextMonthBtn.addEventListener('click', () => {
  currentDate.setMonth(currentDate.getMonth() + 1);
  renderCalendar(currentDate.getFullYear(), currentDate.getMonth());
});
</script>


    </body>
    </html>
